---
import { Image } from "astro:assets";

interface Props {
    title: string;
    description?: string;
    technologies?: string[];
    imageSrc?: string;
    hoverImages?: string[];
    href: string;
    repoUrl?: string;
    demoUrl?: string;
}

const {
    title,
    description = "",
    technologies = [],
    imageSrc,
    hoverImages = [],
    href,
    repoUrl = "#",
    demoUrl = "#",
} = Astro.props;

const images = import.meta.glob<{ default: ImageMetadata }>(
    "/src/assets/**/*.{jpeg,jpg,png,gif}",
    { eager: true }
);
const imagePath = imageSrc ? `/src/assets/${imageSrc}` : null;

if (imagePath && !images[imagePath]) {
    console.error(`Project image not found: ${imagePath}`);
}
---

<a
    href={href}
    data-slideshow-count={hoverImages.length}
    data-repo-url={repoUrl}
    data-demo-url={demoUrl}
    data-description={description}
    data-technologies={JSON.stringify(technologies)}
    data-images={JSON.stringify(hoverImages)}
    class="project-card reveal-item group relative block aspect-square w-full overflow-hidden bg-gray-200 dark:bg-gray-800 opacity-0 translate-y-12 scale-95 transition-all duration-1000 ease-out hover:z-50 hover:scale-105 hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-blue-600 focus:z-50"
    aria-label={`View details for ${title}. Technologies: ${technologies.join(
        ", "
    )}`}
>
    {/* Default Image */}
    <div
        class="absolute inset-0 z-10 transition-opacity duration-300 group-hover:opacity-0"
    >
        {
            imagePath && images[imagePath] ? (
                <Image
                    src={images[imagePath].default}
                    alt={`Project showcase: ${title} - Guilherme Cantarino Portfolio`}
                    class="h-full w-full object-cover"
                />
            ) : (
                <div class="flex h-full w-full items-center justify-center bg-blue-50 dark:bg-blue-900/20 text-blue-200 dark:text-blue-800 font-heading font-black text-2xl uppercase p-4 text-center">
                    {title}
                </div>
            )
        }
    </div>

    {/* Hover Slideshow */}
    <div
        class="absolute inset-0 z-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100 bg-gray-200 dark:bg-gray-800"
    >
        {
            hoverImages.length > 0 ? (
                <div class="slideshow-container relative h-full w-full">
                    {hoverImages.map((img, index) => {
                        const hoverPath = `/src/assets/${img}`;
                        if (images[hoverPath]) {
                            return (
                                <Image
                                    src={images[hoverPath].default}
                                    alt={`Screenshot: ${title} development process - Image ${
                                        index + 1
                                    }`}
                                    class="slideshow-image absolute inset-0 h-full w-full object-cover transition-opacity duration-500 opacity-0"
                                    style={{
                                        opacity: index === 0 ? "1" : "0",
                                        zIndex: index === 0 ? "1" : "0",
                                    }}
                                />
                            );
                        }
                        return null;
                    })}
                </div>
            ) : (
                <div class="flex h-full w-full items-center justify-center bg-blue-600 text-white font-heading font-black text-2xl uppercase p-4 text-center">
                    {title}
                </div>
            )
        }
    </div>

    {/* Overlay Content */}
    <div
        class="absolute inset-0 z-20 flex flex-col items-center justify-center gap-4 opacity-0 transition-all duration-300 group-hover:opacity-100 bg-black/40 px-4 text-center group-focus:opacity-100"
    >
        <h3
            class="font-heading font-black text-2xl text-white uppercase tracking-tighter transform translate-y-4 group-hover:translate-y-0 group-focus:translate-y-0 transition-transform duration-300 delay-75"
        >
            {title}
        </h3>
        <span
            class="rounded-full bg-white px-6 py-2 font-heading text-sm font-bold uppercase tracking-wider text-blue-600 shadow-lg transform translate-y-4 group-hover:translate-y-0 group-focus:translate-y-0 transition-transform duration-300 delay-150"
        >
            Click for details
        </span>
    </div>
</a>

<script>
    function setupSlideshows() {
        const cards = document.querySelectorAll(".project-card");

        cards.forEach((card) => {
            const count = parseInt(
                card.getAttribute("data-slideshow-count") || "0"
            );

            // Add click listener for modal
            card.addEventListener("click", (e) => {
                e.preventDefault();
                const title = card.querySelector("h3")?.textContent || "";
                const href = card.getAttribute("href") || "#";
                const repoUrl = card.getAttribute("data-repo-url") || "#";
                const demoUrl = card.getAttribute("data-demo-url") || "#";
                const description = card.getAttribute("data-description") || "";
                const technologies = JSON.parse(
                    card.getAttribute("data-technologies") || "[]"
                );
                const images = JSON.parse(
                    card.getAttribute("data-images") || "[]"
                );

                window.dispatchEvent(
                    new CustomEvent("open-project-modal", {
                        detail: {
                            title,
                            href,
                            repoUrl,
                            demoUrl,
                            description,
                            technologies,
                            images,
                        },
                    })
                );
            });

            if (count <= 1) return;

            const images = card.querySelectorAll(".slideshow-image");
            let currentIndex = 0;
            let interval: ReturnType<typeof setInterval> | null = null;

            const startSlideshow = () => {
                if (interval) return;
                interval = setInterval(() => {
                    // Hide current
                    (images[currentIndex] as HTMLElement).style.opacity = "0";
                    (images[currentIndex] as HTMLElement).style.zIndex = "0";

                    // Show next
                    currentIndex = (currentIndex + 1) % images.length;
                    (images[currentIndex] as HTMLElement).style.opacity = "1";
                    (images[currentIndex] as HTMLElement).style.zIndex = "1";
                }, 1000);
            };

            const stopSlideshow = () => {
                if (interval) {
                    clearInterval(interval);
                    interval = null;
                }
                // Reset to first image
                images.forEach((img, idx) => {
                    (img as HTMLElement).style.opacity = idx === 0 ? "1" : "0";
                    (img as HTMLElement).style.zIndex = idx === 0 ? "1" : "0";
                });
                currentIndex = 0;
            };

            card.addEventListener("mouseenter", startSlideshow);
            card.addEventListener("mouseleave", stopSlideshow);
        });
    }

    // Run on initial load
    setupSlideshows();

    // Support View Transitions if enabled
    document.addEventListener("astro:page-load", setupSlideshows);
</script>
